{% extends 'base.html' %}
{% load static %}

{% block title %}Add Item - {{ block.super }}{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="item-create-form">
    <h1>Add New Item</h1>
    
    {% if form.non_field_errors %}
        <div class="alert alert-error">
            <strong>Form errors:</strong>
            <ul>
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    {% if form.errors %}
        <div class="alert alert-error">
            <strong>Please correct the following errors:</strong>
            <ul>
                {% for field, errors in form.errors.items %}
                    <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    <form method="post" enctype="multipart/form-data" id="item-create-form">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="{{ form.title.id_for_label }}">Title *</label>
            {{ form.title }}
            {% if form.title.errors %}
                <div class="form-error">{{ form.title.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.price_amount.id_for_label }}">Price (NZD) *</label>
            <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                <span style="font-size: var(--font-size-lg); font-weight: 600;">$</span>
                {{ form.price_amount }}
            </div>
            {% if form.price_amount.errors %}
                <div class="form-error">{{ form.price_amount.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.description.id_for_label }}">Description (optional)</label>
            {{ form.description }}
            {% if form.description.errors %}
                <div class="form-error">{{ form.description.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.category.id_for_label }}">Category (optional)</label>
            {{ form.category }}
            {% if form.category.errors %}
                <div class="form-error">{{ form.category.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group image-upload-section">
            <label>Photos *</label>
            <p style="font-size: var(--font-size-sm); color: var(--color-text-light); margin-bottom: var(--spacing-sm);">
                Add at least one photo. First photo will be the main image.
            </p>
            
            <div class="image-upload-buttons">
                <button type="button" class="camera-button" onclick="openCamera()">
                    üì∑ Take Photo
                </button>
                <button type="button" class="gallery-button" onclick="openGallery()">
                    üñºÔ∏è Choose from Gallery
                </button>
            </div>
            
            <div class="file-input-wrapper">
                <input 
                    type="file" 
                    id="images-input" 
                    name="images"
                    accept="image/*" 
                    multiple
                    class="file-input-hidden"
                >
            </div>
            
            <div id="image-preview-container" class="image-preview-grid"></div>
        </div>
        
        <div class="submit-section">
            <button type="submit" class="btn btn-primary submit-button" id="submit-btn">Create Item</button>
        </div>
    </form>
</div>

<script src="{% static 'js/item_create.js' %}"></script>
<script>
// Handle form submission with fetch to properly send images
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('item-create-form');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Check if images are selected
        if (!window.selectedImages || window.selectedImages.length === 0) {
            alert('Please add at least one photo');
            return false;
        }
        
        // Create FormData and append all form fields + files
        const formData = new FormData(form);
        
        // Remove any existing images from FormData
        formData.delete('images');
        
        // Append all selected images
        window.selectedImages.forEach((file) => {
            formData.append('images', file);
        });
        
        // Show loading state
        const submitBtn = document.getElementById('submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Submit with fetch
        fetch(form.action || window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            redirect: 'follow'
        })
        .then(response => {
            // Django redirects after successful form submission
            // Check if we were redirected to a different URL
            if (response.redirected || response.url !== window.location.href) {
                // Success! Redirect to the new item page
                window.location.href = response.url;
                return;
            }
            
            // If not redirected, there might be form errors
            // Replace the page content to show errors
            return response.text().then(html => {
                document.open();
                document.write(html);
                document.close();
            });
        })
        .catch(error => {
            console.error('Form submission error:', error);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            alert('Error submitting form. Please try again.');
        });
    });
});
</script>
{% endblock %}
